#------------------------------------------------------
# Copyright (c) 2025, Elehobica
# Released under the BSD-2-Clause
# refer to https://opensource.org/licenses/BSD-2-Clause
#------------------------------------------------------

name: Nightly Build & Test

on:
  schedule:
    # æ¯æ—¥åˆå‰3æ™‚ï¼ˆUTCï¼‰ã«å®Ÿè¡Œ
    - cron: '0 3 * * *'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  # å…¨ã‚µãƒ³ãƒ—ãƒ«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ“ãƒ«ãƒ‰
  comprehensive-build:
    name: Comprehensive Build Test
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform: [rp2040, rp2350]
        build_type: [Release, Debug, MinSizeRel]
        include:
          - platform: rp2040
            board: pico
          - platform: rp2350
            board: pico2
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Setup Pico SDK and dependencies
        run: |
          # Pico SDKã‚’ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚¯ãƒ­ãƒ¼ãƒ³
          git clone -b 2.1.1 --depth 1 https://github.com/raspberrypi/pico-sdk.git pico-sdk-external
          cd pico-sdk-external
          git submodule update --init
          cd ..
          
          # ARM GCCãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi make
          
          # ç’°å¢ƒå¤‰æ•°ã‚’GitHub Actionsã®ç’°å¢ƒã«è¨­å®š
          echo "PICO_SDK_PATH=${{ github.workspace }}/pico-sdk-external" >> $GITHUB_ENV
          echo "PICO_EXTRAS_PATH=${{ github.workspace }}/libs/pico-extras" >> $GITHUB_ENV

      - name: Find all sample projects
        id: find_samples
        run: |
          # samplesãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå†…ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’æ¤œç´¢
          projects=$(find samples -name "CMakeLists.txt" -exec dirname {} \; | sort)
          echo "Found projects:"
          echo "$projects"
          echo "projects<<EOF" >> $GITHUB_OUTPUT
          echo "$projects" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Build all samples
        run: |
          while IFS= read -r project; do
            if [ -n "$project" ] && [ -d "$project" ]; then
              echo "Building $project for ${{ matrix.platform }} (${{ matrix.build_type }})"
              
              # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç§»å‹•
              cd "$project"
              
              # ãƒ“ãƒ«ãƒ‰ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
              BUILD_DIR="build_${{ matrix.platform }}_${{ matrix.build_type }}"
              mkdir -p "$BUILD_DIR"
              cd "$BUILD_DIR"
              
              # CMakeè¨­å®š
              cmake \
                -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
                -DPICO_PLATFORM=${{ matrix.platform }} \
                -DPICO_BOARD=${{ matrix.board }} \
                ..
              
              # ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
              make -j$(nproc)
              
              # æˆæœç‰©ã®ç¢ºèª
              ls -la *.uf2 *.elf 2>/dev/null || echo "No binary files generated"
              
              # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«æˆ»ã‚‹
              cd - > /dev/null
              cd - > /dev/null
            fi
          done <<< "${{ steps.find_samples.outputs.projects }}"

      - name: Collect build artifacts
        run: |
          echo "=== Build Summary ===" 
          find samples -name "*.uf2" -o -name "*.elf" | sort

  # ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ãƒˆãƒ¬ãƒ³ãƒ‰åˆ†æ
  memory-trend:
    name: Memory Usage Trend
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 50  # éå»50ã‚³ãƒŸãƒƒãƒˆã‚’å–å¾—

      - name: Setup Pico SDK and dependencies
        run: |
          # Pico SDKã‚’ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚¯ãƒ­ãƒ¼ãƒ³
          git clone -b 2.1.1 --depth 1 https://github.com/raspberrypi/pico-sdk.git pico-sdk-external
          cd pico-sdk-external
          git submodule update --init
          cd ..
          
          # ARM GCCãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi
          
          # ç’°å¢ƒå¤‰æ•°ã‚’GitHub Actionsã®ç’°å¢ƒã«è¨­å®š
          echo "PICO_SDK_PATH=${{ github.workspace }}/pico-sdk-external" >> $GITHUB_ENV
          echo "PICO_EXTRAS_PATH=${{ github.workspace }}/libs/pico-extras" >> $GITHUB_ENV

      - name: Verify pico-extras structure
        run: |
          echo "=== Pico-extras Diagnostic ==="
          echo "Working directory: $(pwd)"
          echo "Workspace: ${{ github.workspace }}"
          echo "PICO_EXTRAS_PATH: ${{ github.workspace }}/libs/pico-extras"
          
          # ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªæ§‹é€ ã®ç¢ºèª
          ls -la libs/ || echo "libs directory not found"
          ls -la libs/pico-extras/ || echo "pico-extras directory not found"
          
          # é‡è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          [ -f "libs/pico-extras/post_init.cmake" ] && echo "âœ… post_init.cmake found" || echo "âŒ post_init.cmake missing"
          [ -f "libs/pico-extras/external/pico_extras_import.cmake" ] && echo "âœ… pico_extras_import.cmake found" || echo "âŒ pico_extras_import.cmake missing"
          
          # ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«çŠ¶æ…‹ã®ç¢ºèª  
          git submodule status | grep pico-extras || echo "pico-extras not in submodules"

      - name: Build current version
        run: |
          cd samples/sine_wave_i2s_32b
          mkdir -p build_current
          cd build_current
          cmake -DPICO_PLATFORM=rp2040 -DPICO_BOARD=pico ..
          make -j$(nproc)

      - name: Analyze memory usage
        run: |
          # ç¾åœ¨ã®ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’è¨˜éŒ²
          if [ -f "samples/sine_wave_i2s_32b/build_current/sine_wave_i2s_32b.elf" ]; then
            echo "=== Current Memory Usage ===" 
            arm-none-eabi-size samples/sine_wave_i2s_32b/build_current/sine_wave_i2s_32b.elf
            
            # ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ã‚’ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
            arm-none-eabi-size samples/sine_wave_i2s_32b/build_current/sine_wave_i2s_32b.elf | tail -1 > memory_usage.txt
            cat memory_usage.txt
          fi

      - name: Upload memory trend data
        uses: actions/upload-artifact@v4
        with:
          name: memory-trend-$(date +%Y%m%d)
          path: memory_usage.txt
          retention-days: 90

  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ™ãƒ³ãƒãƒãƒ¼ã‚¯
  performance-benchmark:
    name: Performance Benchmark
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Setup Pico SDK and dependencies
        run: |
          # Pico SDKã‚’ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ã‚¯ãƒ­ãƒ¼ãƒ³
          git clone -b 2.1.1 --depth 1 https://github.com/raspberrypi/pico-sdk.git pico-sdk-external
          cd pico-sdk-external
          git submodule update --init
          cd ..
          
          # ARM GCCãƒ„ãƒ¼ãƒ«ãƒã‚§ãƒ¼ãƒ³ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          sudo apt-get update
          sudo apt-get install -y gcc-arm-none-eabi make
          
          # ç’°å¢ƒå¤‰æ•°ã‚’GitHub Actionsã®ç’°å¢ƒã«è¨­å®š
          echo "PICO_SDK_PATH=${{ github.workspace }}/pico-sdk-external" >> $GITHUB_ENV
          echo "PICO_EXTRAS_PATH=${{ github.workspace }}/libs/pico-extras" >> $GITHUB_ENV

      - name: Compile-time benchmark
        run: |
          echo "=== Compile Time Benchmark ==="
          
          # ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚é–“ã®æ¸¬å®š
          cd samples/sine_wave_i2s_32b
          mkdir -p build_benchmark && cd build_benchmark
          
          echo "Starting RP2040 build..."
          time_rp2040=$(TIMEFORMAT='%R'; { time cmake -DPICO_PLATFORM=rp2040 -DPICO_BOARD=pico .. && make -j$(nproc); } 2>&1)
          echo "RP2040 build time: $time_rp2040"
          
          # ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          cd .. && rm -rf build_benchmark && mkdir build_benchmark && cd build_benchmark
          
          echo "Starting RP2350 build..."
          time_rp2350=$(TIMEFORMAT='%R'; { time cmake -DPICO_PLATFORM=rp2350 -DPICO_BOARD=pico2 .. && make -j$(nproc); } 2>&1)
          echo "RP2350 build time: $time_rp2350"

      - name: Code metrics
        run: |
          echo "=== Code Metrics ==="
          
          # è¡Œæ•°çµ±è¨ˆ
          echo "Source lines of code:"
          find samples products libs/pico_audio_32b libs/pico_audio_core -name "*.c" -o -name "*.cpp" -o -name "*.h" 2>/dev/null | xargs wc -l 2>/dev/null | tail -1 || echo "No source files found"
          
          # ãƒ•ã‚¡ã‚¤ãƒ«æ•°çµ±è¨ˆ
          echo "Number of source files:"
          find samples products libs/pico_audio_32b libs/pico_audio_core -name "*.c" -o -name "*.cpp" -o -name "*.h" 2>/dev/null | wc -l
          
          # æœ€å¤§ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º
          echo "Largest source files:"
          find samples products libs/pico_audio_32b libs/pico_audio_core -name "*.c" -o -name "*.cpp" -o -name "*.h" 2>/dev/null -exec wc -l {} + | sort -nr | head -5

  # ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
  dependency-check:
    name: Dependency Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 1

      - name: Check submodule status
        run: |
          echo "=== Submodule Status ==="
          git submodule status
          
          # å„ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æœ€æ–°çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
          git submodule foreach 'echo "Checking $name:"; git log --oneline -5'

      - name: Validate pico-extras
        run: |
          echo "=== Pico-extras Validation ==="
          if [ -d "libs/pico-extras" ]; then
            cd libs/pico-extras
            # pico-extrasã®åŸºæœ¬çš„ãªæ§‹é€ ã‚’ãƒã‚§ãƒƒã‚¯
            [ -d "src" ] || (echo "pico-extras src directory missing" && exit 1)
            [ -f "external/pico_extras_import.cmake" ] || (echo "pico_extras_import.cmake missing" && exit 1)
            echo "âœ… pico-extras structure is valid"
          else
            echo "âŒ pico-extras directory not found"
            exit 1
          fi

      - name: Check SDK compatibility
        run: |
          echo "=== SDK Compatibility Check ==="
          # SDKè¦ä»¶ã®ãƒã‚§ãƒƒã‚¯
          echo "Checking for required SDK features..."
          
          # CMakeãƒ•ã‚¡ã‚¤ãƒ«ã§ã®SDKãƒãƒ¼ã‚¸ãƒ§ãƒ³è¦ä»¶ã‚’ãƒã‚§ãƒƒã‚¯
          grep -r "cmake_minimum_required" . | grep -v build | head -5

  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ç›£æŸ»
  security-audit:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # å…¨å±¥æ­´ã‚’å–å¾—

      - name: Check for sensitive data
        run: |
          echo "=== Security Audit ==="
          
          # æ©Ÿå¯†æƒ…å ±ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
          patterns=(
            "password"
            "secret"
            "private.*key"
            "api.*key"
            "token"
            "credential"
          )
          
          for pattern in "${patterns[@]}"; do
            echo "Checking for pattern: $pattern"
            if git log --all --grep="$pattern" --oneline | grep -v "ssh.*key\|public.*key"; then
              echo "âš ï¸ Potential sensitive data found in commit messages"
            fi
          done

      - name: Check file permissions
        run: |
          echo "=== File Permission Check ==="
          
          # å®Ÿè¡Œå¯èƒ½ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒã‚§ãƒƒã‚¯
          find . -type f -executable -not -path "./.git/*" -not -path "./build/*" | while read file; do
            echo "Executable file found: $file"
          done

      - name: License compliance
        run: |
          echo "=== License Compliance ==="
          
          # ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          [ -f "LICENSE" ] || echo "âš ï¸ LICENSE file not found"
          
          # ã‚½ãƒ¼ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ãƒã‚§ãƒƒã‚¯
          missing_license=0
          find samples products libs/pico_audio_32b libs/pico_audio_core -name "*.c" -o -name "*.cpp" -o -name "*.h" 2>/dev/null | while read file; do
            if ! head -10 "$file" | grep -q -i "license\|copyright"; then
              echo "âš ï¸ $file missing license header"
              missing_license=$((missing_license + 1))
            fi
          done

  # ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
  nightly-report:
    name: Nightly Report
    runs-on: ubuntu-latest
    needs: [comprehensive-build, memory-trend, performance-benchmark, dependency-check, security-audit]
    if: always()
    steps:
      - name: Generate nightly report
        run: |
          echo "# ğŸŒ™ Nightly Build Report - $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Build Status" >> $GITHUB_STEP_SUMMARY
          echo "| Component | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Comprehensive Build | ${{ needs.comprehensive-build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Memory Trend | ${{ needs.memory-trend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Performance | ${{ needs.performance-benchmark.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Dependencies | ${{ needs.dependency-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Security | ${{ needs.security-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # ç·åˆè©•ä¾¡
          if [[ "${{ needs.comprehensive-build.result }}" == "success" && 
                "${{ needs.dependency-check.result }}" == "success" ]]; then
            echo "âœ… **Nightly build passed successfully**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Nightly build encountered issues**" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“Š Detailed results available in individual job logs." >> $GITHUB_STEP_SUMMARY